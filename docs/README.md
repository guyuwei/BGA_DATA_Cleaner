# BGA DATA 数据处理流程

## 📋 执行流程

### 快速执行（推荐）

```bash
cd /Users/gyw/Desktop/Project/2025/BGA/DATA

# ⚡ 步骤1：合并+整理列（并行加速版，47.9秒）
python3 步骤1_重新开始.py

# 步骤2：筛选患者（29.2秒）
python3 步骤2_StudyCohort筛选.py

# 步骤3：药物分析+变量提取（18.9秒）
python3 步骤3_药物医嘱整理.py
```

**总耗时：~96秒（约1.6分钟）**

---

## 📊 各步骤详情

### 步骤1：重新开始 + 整理列 ⚡

**功能：**
1. 清理旧数据
2. 并行合并原始文件（Health组3个批次 + HYPO组2个批次）
3. 并行构建`admission_key = patient_sn + "_" + time_quantum`
4. 并行重命名文件为中文
5. 并行整理列（删除冗余列、空列）

**性能：**
- 原始串行版本：73.1秒
- **并行加速版本：47.9秒（提升34%）** ✨
- 备份文件：`步骤1_重新开始_原始串行版.py.bak`

**输出：**
- `Health/` 目录：12个文件，~367,080个患者
- `HYPO/` 目录：12个文件，~42,068个患者

**详细说明：** 见 `步骤1_性能优化说明.md`

---

### 步骤2：Study Cohort 筛选

**功能：**
1. 诊断排除：妊娠糖尿病、死亡
2. 科室排除：CCU、EICU、重症医学科等

**结果：**

| 组别 | 原始患者数 | 排除患者数 | 最终患者数 | 删除记录数 |
|------|-----------|-----------|-----------|-----------|
| Health | 367,080 | 86 | 366,994 | 31,997 |
| HYPO | 42,068 | 210 | 41,858 | 192,485 |

**输出：**
- 所有文件已更新，仅保留符合条件的患者

---

### 步骤3：药物医嘱整理

**功能：**
1. 清理制表符
2. 排除"已撤销"医嘱（在统计时排除，不删除记录）
3. 提取降糖药物使用情况（13个二元变量）
4. 特殊规则处理：
   - 艾托格列净：检查J列（商品名）和H列（通用名）
   - 胰岛素注射液：根据给药途径判断
   - 预混胰岛素：排除25r、50r、30等标记

**结果：**

**Health组（366,994患者）：**
- OADS（口服降糖药）：9,641人（2.6%）
- INSULIN（胰岛素）：4,795人（1.3%）
- 艾托格列净：272人（通过J列和H列匹配）

**HYPO组（41,858患者）：**
- OADS（口服降糖药）：1,426人（3.4%）
- INSULIN（胰岛素）：1,367人（3.3%）
- 艾托格列净：34人

**输出：**
- `Health/变量_降糖药物.csv`：366,994行 × 14列
- `HYPO/变量_降糖药物.csv`：41,858行 × 14列
- `降糖药物变量说明.txt`

**变量列表（13个）：**
1. OADS - 口服降糖药（合并）
2. INSULIN - 胰岛素（合并）
3. METFORMIN - 二甲双胍类
4. SU - 磺脲类
5. GLINIDES - 格列奈类
6. TZD - 噻唑烷二酮类
7. AGI - α-葡萄糖苷酶抑制剂
8. DPP4I - 二肽基肽酶-4抑制剂
9. SGLT2I - SGLT-2抑制剂（包括艾托格列净）
10. INSULIN_RAPID - 餐时胰岛素
11. INSULIN_BASAL - 基础胰岛素
12. INSULIN_DUAL - 双胰岛素
13. INSULIN_PREMIX - 预混胰岛素

---

## 📂 目录结构

```
/Users/gyw/Desktop/Project/2025/BGA/DATA/
├── 微信原文件！！/                    # 原始数据（5个批次）
├── Health/                           # Health组处理后数据（12个文件）
│   ├── 诊断.csv
│   ├── 药品医嘱.csv
│   ├── 非药品医嘱.csv
│   ├── 变量_降糖药物.csv            # 降糖药物变量
│   └── ...
├── HYPO/                            # HYPO组处理后数据（12个文件）
│   ├── 诊断.csv
│   ├── 药品医嘱.csv
│   ├── 非药品医嘱.csv
│   ├── 变量_降糖药物.csv            # 降糖药物变量
│   └── ...
├── 步骤1_重新开始.py                # 并行加速版（当前使用）
├── 步骤1_重新开始_原始串行版.py.bak  # 原始版本备份
├── 步骤1_性能优化说明.md            # 性能优化详情
├── 步骤2_StudyCohort筛选.py
├── 步骤3_药物医嘱整理.py
├── 降糖药物变量说明.txt              # 药物变量详细说明
├── 变量整理计划.txt                 # 后续变量提取计划
└── README.md                        # 本文件
```

---

## 🔄 数据流转

```
原始数据（5个批次）
    ↓ 步骤1：合并+整理列（并行）
Health组（367,080患者）+ HYPO组（42,068患者）
    ↓ 步骤2：筛选患者
Health组（366,994患者）+ HYPO组（41,858患者）
    ↓ 步骤3：药物变量提取
降糖药物变量（13个二元变量）
    ↓ 步骤4-N：其他变量提取（待开发）
完整特征表
```

---

## 📝 数据处理规则

### admission_key 构建
- 格式：`patient_sn + "_" + time_quantum`
- 示例：`ffdfc68bdb37be4cd2ce834fa31fd94f_时间段1`
- 作用：唯一标识每个患者的住院记录

### 患者排除规则
1. **诊断排除：**
   - 妊娠糖尿病：9个患者（Health组）
   - 死亡：6个患者（Health组），3个患者（HYPO组）

2. **科室排除：**
   - CCU病房、EICU、监护病房、重症医学科等
   - Health组：72个患者
   - HYPO组：209个患者

### 药物处理规则
1. **已撤销医嘱：** 在统计时排除，但保留记录
2. **制表符清理：** 自动清理J、H、K、R列的制表符
3. **艾托格列净特殊规则：** 检查J列（商品名）和H列（通用名）
4. **胰岛素注射液特殊规则：** 
   - K列="胰岛素" + J列="胰岛素注射液" + R列="皮下/皮内/肌肉注射" → 餐时胰岛素
   - 其他给药途径（辅药、静脉滴注等）：排除
5. **预混胰岛素排除：** 含25r、50r、30等标记的不归入餐时胰岛素

---

## 🎯 下一步计划

根据`变量整理计划.txt`，后续需要提取：

1. **人口统计学变量** (Demographics)
2. **合并症变量** (Comorbidities)
3. **实验室指标** (Laboratory)
4. **生命体征** (Vital Signs)
5. **血糖指标** (Glycemic Metrics)
6. **住院信息** (Hospitalization)

---

## ⚡ 性能优化

### 步骤1 并行优化
- 使用`ThreadPoolExecutor`实现并行处理
- 8个线程同时处理多个文件
- 适合I/O密集型的CSV文件读写操作

**性能提升：**
- 文件合并：48%（30秒 → 15.5秒）
- admission_key构建：20%（20秒 → 16.1秒）
- 文件重命名：99%（1秒 → 0.0秒）
- 列整理：18%（20秒 → 16.3秒）

**总提升：34%（73.1秒 → 47.9秒）**

详见：`步骤1_性能优化说明.md`

---

## ⚠️ 注意事项

1. **数据完整性：**
   - 每次运行步骤1会清空Health和HYPO目录
   - 建议备份重要数据

2. **执行顺序：**
   - 必须按顺序执行步骤1 → 步骤2 → 步骤3
   - 步骤2依赖步骤1的输出
   - 步骤3依赖步骤2的输出

3. **内存需求：**
   - 处理大文件需要足够内存（建议8GB+）
   - 并行版本会同时读取多个文件

4. **Python版本：**
   - 需要Python 3.x
   - 依赖pandas、pathlib等库

---

## 📧 问题反馈

如遇到问题，请检查：
1. 原始数据路径是否正确
2. Python环境和依赖是否完整
3. 是否按顺序执行步骤
4. 查看各步骤的输出日志

---

**最后更新：** 2026-02-02  
**版本：** v1.0（并行加速版）
